{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import { Reporter, TestCaseResult } from '@jest/reporters';\nimport { Test } from '@jest/test-result';\nimport { Circus } from '@jest/types';\nimport { Config } from 'jest';\nimport {\n  ApplauseConfig,\n  ApplauseReporter,\n  TestResultStatus,\n  loadConfig,\n} from 'applause-reporter-common';\n\nexport default class ApplauseJestReporter implements Reporter {\n  private reporter: ApplauseReporter;\n\n  constructor(\n    public globalConfig: Config,\n    options: Partial<ApplauseConfig>\n  ) {\n    const config = loadConfig({\n      properties: options,\n    });\n    this.reporter = new ApplauseReporter(config);\n  }\n\n  onRunStart(): void {\n    void this.reporter.runnerStart();\n  }\n\n  async onRunComplete(): Promise<void> {\n    await this.reporter.runnerEnd();\n  }\n\n  onTestCaseStart(\n    _test: Test,\n    _testCaseStartInfo: Circus.TestCaseStartInfo\n  ): void {\n    void this.reporter.startTestCase(\n      _testCaseStartInfo.fullName,\n      _testCaseStartInfo.title,\n      {\n        providerSessionIds: globalThis.driverRegistry.getSessionIdsForTestCase(\n          _testCaseStartInfo.fullName\n        ),\n      }\n    );\n  }\n\ncleanErrorMessage(str?: string): string | undefined {\n    // eslint-disable-next-line no-control-regex\n    return str?.replace(/\\x1B\\[[0-9;]*m/g, '');\n}\n  onTestCaseResult(_test: Test, _testCaseResult: TestCaseResult): void {\n    \n    // 1. Map over the failure messages and clean each one.\n    const cleanedMessages = _testCaseResult.failureMessages.map(msg => this.cleanErrorMessage(msg) || '');\n\n    // 2. Join the cleaned messages with a newline for better readability.\n    const failureReason = cleanedMessages.join('\\n');\n\n    void this.reporter.submitTestCaseResult(\n      _testCaseResult.fullName,\n      this.mapStatus(_testCaseResult),\n      {\n        // 3. Use the fully cleaned and formatted string.\n        failureReason: failureReason,\n        providerSessionGuids:\n          globalThis.driverRegistry.getSessionIdsForTestCase(\n            _testCaseResult.fullName\n          ),\n      }\n    );\n  }\n\n  private mapStatus(result: TestCaseResult): TestResultStatus {\n    switch (result.status) {\n      case 'passed':\n        return TestResultStatus.PASSED;\n      case 'disabled':\n        return TestResultStatus.SKIPPED;\n      case 'failed':\n        return TestResultStatus.FAILED;\n      case 'skipped':\n        return TestResultStatus.SKIPPED;\n      default:\n        throw new Error(\n          'yo, you shouldnt use this for tests that arent in a status auto-api doesnt support'\n        );\n    }\n  }\n}\n"],"names":["loadConfig","ApplauseReporter","TestResultStatus"],"mappings":";;;;AAWc,MAAO,oBAAoB,CAAA;AAI9B,IAAA,YAAA,CAAA;AAHD,IAAA,QAAQ,CAAmB;IAEnC,WACS,CAAA,YAAoB,EAC3B,OAAgC,EAAA;QADzB,IAAY,CAAA,YAAA,GAAZ,YAAY,CAAQ;QAG3B,MAAM,MAAM,GAAGA,iCAAU,CAAC;AACxB,YAAA,UAAU,EAAE,OAAO;AACpB,SAAA,CAAC,CAAC;QACH,IAAI,CAAC,QAAQ,GAAG,IAAIC,uCAAgB,CAAC,MAAM,CAAC,CAAC;KAC9C;IAED,UAAU,GAAA;AACR,QAAA,KAAK,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC;KAClC;AAED,IAAA,MAAM,aAAa,GAAA;AACjB,QAAA,MAAM,IAAI,CAAC,QAAQ,CAAC,SAAS,EAAE,CAAC;KACjC;IAED,eAAe,CACb,KAAW,EACX,kBAA4C,EAAA;AAE5C,QAAA,KAAK,IAAI,CAAC,QAAQ,CAAC,aAAa,CAC9B,kBAAkB,CAAC,QAAQ,EAC3B,kBAAkB,CAAC,KAAK,EACxB;YACE,kBAAkB,EAAE,UAAU,CAAC,cAAc,CAAC,wBAAwB,CACpE,kBAAkB,CAAC,QAAQ,CAC5B;AACF,SAAA,CACF,CAAC;KACH;AAEH,IAAA,iBAAiB,CAAC,GAAY,EAAA;;QAE1B,OAAO,GAAG,EAAE,OAAO,CAAC,iBAAiB,EAAE,EAAE,CAAC,CAAC;KAC9C;IACC,gBAAgB,CAAC,KAAW,EAAE,eAA+B,EAAA;;QAG3D,MAAM,eAAe,GAAG,eAAe,CAAC,eAAe,CAAC,GAAG,CAAC,GAAG,IAAI,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;;QAGtG,MAAM,aAAa,GAAG,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AAEjD,QAAA,KAAK,IAAI,CAAC,QAAQ,CAAC,oBAAoB,CACrC,eAAe,CAAC,QAAQ,EACxB,IAAI,CAAC,SAAS,CAAC,eAAe,CAAC,EAC/B;;AAEE,YAAA,aAAa,EAAE,aAAa;YAC5B,oBAAoB,EAClB,UAAU,CAAC,cAAc,CAAC,wBAAwB,CAChD,eAAe,CAAC,QAAQ,CACzB;AACJ,SAAA,CACF,CAAC;KACH;AAEO,IAAA,SAAS,CAAC,MAAsB,EAAA;AACtC,QAAA,QAAQ,MAAM,CAAC,MAAM;AACnB,YAAA,KAAK,QAAQ;gBACX,OAAOC,uCAAgB,CAAC,MAAM,CAAC;AACjC,YAAA,KAAK,UAAU;gBACb,OAAOA,uCAAgB,CAAC,OAAO,CAAC;AAClC,YAAA,KAAK,QAAQ;gBACX,OAAOA,uCAAgB,CAAC,MAAM,CAAC;AACjC,YAAA,KAAK,SAAS;gBACZ,OAAOA,uCAAgB,CAAC,OAAO,CAAC;AAClC,YAAA;AACE,gBAAA,MAAM,IAAI,KAAK,CACb,oFAAoF,CACrF,CAAC;SACL;KACF;AACF;;;;"}